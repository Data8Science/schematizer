"""
zlib compressed Python pickling.

Implements module level `dumps()`, and `loads()`.
"""

import cPickle
import zlib


def dumps(obj, protocol=2):
    """Dump `obj` to a pickle string and return a zlib (level 6) compressed
    string.

    `protocol` defaults to 2, which is the most efficient and backwards
    compatible to Python 2.3. By default, `pickle.dumps()` defaults to
    `protocol=0`.
    """
    return zlib.compress(cPickle.dumps(obj, protocol))


def loads(pickle_string):
    """Try decompressing `pickle_string`, and then return the unpickled object.

    If decompressing fails, try unpickling and returning the original string.
    """
    try:
        pickle_string = zlib.decompress(pickle_string)
    except zlib.error:
        pass

    return cPickle.loads(pickle_string)
